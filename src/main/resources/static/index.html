<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arrikai Malar - Job Listings</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>Arrikai Malar</h1>
      <p>Your minimalist portal for professional opportunities.</p>
      <div class="header-actions">
        <a href="hire.html" class="btn post-job-btn">Post a Job</a>
        <button id="logout-btn" class="btn logout-btn">Logout</button>
      </div>
    </header>

    <div class="search-container">
      <input type="text" id="search-input" placeholder="Search by skill (e.g., Java, React)...">
      <button id="search-btn" class="btn">Search</button>
    </div>

    <main id="job-listings">
      <!-- Job cards will be dynamically inserted here -->
    </main>
  </div>

  <script>
    const listingsContainer = document.getElementById('job-listings');
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('search-btn');
    const logoutBtn = document.getElementById('logout-btn');

    // ðŸ”‘ Check if token exists, else redirect to login
    function getToken() {
      const token = localStorage.getItem('jwtToken');
      if (!token) {
        window.location.href = '/login.html';
      }
      return token;
    }

    // Function to render job cards
    function renderJobs(jobs) {
      listingsContainer.innerHTML = '';

      if (!jobs || jobs.length === 0) {
        listingsContainer.innerHTML = '<p class="no-jobs">No matching jobs found.</p>';
        return;
      }

      jobs.forEach(job => {
        const jobCard = document.createElement('div');
        jobCard.className = 'job-card';
        jobCard.innerHTML = `
          <h3>${job.jobTitle}</h3>
          <h4>${job.company} - <span class="location">${job.location}</span></h4>
          <p>${job.jobDescription}</p>
          <div class="skills"><strong>Skills:</strong> ${job.skills.join(', ')}</div>
          <div class="details">
            <span><strong>Experience:</strong> ${job.experience} years</span>
            <span><strong>Interview Date:</strong> ${job.interviewDate}</span>
          </div>
          <div class="address"><strong>Office Address:</strong> ${job.officeAdress}</div>
        `;
        listingsContainer.appendChild(jobCard);
      });
    }

    // Fetch jobs with Authorization header
    async function fetchJobs(url) {
      try {
        const token = getToken();
        const response = await fetch(url, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          if (response.status === 401) {
            localStorage.removeItem('jwtToken');
            window.location.href = '/login.html';
          }
          throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const jobs = await response.json();
        renderJobs(jobs);
      } catch (error) {
        console.error('Error fetching jobs:', error);
        listingsContainer.innerHTML = '<p class="no-jobs">Could not load jobs. Please try again later.</p>';
      }
    }

    // Search button event
    searchBtn.addEventListener('click', () => {
      const skill = searchInput.value.trim();
      if (skill) {
        fetchJobs(`/searchskill/${skill}`);
      } else {
        fetchJobs('/getjobs');
      }
    });

    // Enter key triggers search
    searchInput.addEventListener('keyup', (event) => {
      if (event.key === 'Enter') {
        searchBtn.click();
      }
    });

    // Logout
    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('jwtToken');
      window.location.href = '/login.html';
    });

    // Initial load
    document.addEventListener('DOMContentLoaded', () => {
      fetchJobs('/getjobs');
    });
  </script>
</body>
</html>
